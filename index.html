<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Aura AI Noir | Final Masterpiece</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Montserrat:wght@300;900&display=swap');
        
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Montserrat', sans-serif; color: #fff; }
        #video { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; object-fit: cover; z-index: 1; filter: grayscale(1) brightness(0.8); }
        canvas { display: none; } 

        /* شاشة التشغيل الآمن */
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 10000; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1s;
        }
        #boot-btn {
            padding: 22px 50px; background: #fff; color: #000;
            border: none; border-radius: 5px; font-weight: 900;
            font-size: 16px; cursor: pointer; letter-spacing: 5px;
            box-shadow: 0 0 30px rgba(255,255,255,0.2);
        }

        /* واجهة التصوير */
        #ui { position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        
        #shutter {
            width: 85px; height: 85px; border-radius: 50%; border: 4px solid #fff;
            background: none; position: relative; cursor: pointer; display: flex;
            align-items: center; justify-content: center; transition: 0.4s;
        }
        #shutter-inner { width: 65px; height: 65px; background: #fff; border-radius: 50%; transition: 0.4s; }
        #shutter.recording { border-color: #ff004c; }
        #shutter.recording #shutter-inner { background: #ff004c; border-radius: 12px; transform: scale(0.6); animation: pulse 1s infinite; }

        /* شاشة الرندر بـ AI */
        #ai-engine {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 20000; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .progress-box { width: 280px; height: 2px; background: #111; margin-top: 30px; position: relative; }
        .progress-bar { position: absolute; top:0; left:0; height:100%; width:0%; background: #fff; box-shadow: 0 0 20px #fff; }

        #timer { position: fixed; top: 50px; left: 50%; transform: translateX(-50%); font-family: 'Oswald'; font-size: 35px; color: #fff; display: none; z-index: 1000; }
        .scanline { position: absolute; width: 100%; height: 2px; background: rgba(255,255,255,0.1); top: 0; animation: scan 3s linear infinite; }

        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="boot-screen">
    <div style="font-size: 10px; letter-spacing: 10px; color: #444; margin-bottom: 25px;">AI RECONSTRUCTION SYSTEM</div>
    <button id="boot-btn" onclick="startAura()">ACTIVATE CORE</button>
</div>

<div id="ai-engine">
    <div class="scanline"></div>
    <div style="font-family:'Oswald'; font-size: 28px; font-style: italic; letter-spacing: 5px;">AI RENDERING</div>
    <div style="font-size: 9px; color: #555; margin-top: 10px; letter-spacing: 3px;" id="ai-task">PROCESSING NEURAL NOIR...</div>
    <div class="progress-box"><div id="p-bar" class="progress-bar"></div></div>
    <div id="p-text" style="font-size: 10px; margin-top: 15px; color: #fff;">0%</div>
</div>

<div id="timer">00:40</div>

<video id="video" autoplay playsinline muted></video>
<canvas id="canvas"></canvas>

<div id="ui">
    <div style="font-size: 9px; letter-spacing: 4px; color: #555; font-weight: 900;">1080P | RAW 24FPS | NOIR LENS</div>
    <div id="shutter" onclick="toggleCapture()">
        <div id="shutter-inner"></div>
    </div>
</div>

<!-- محرك الفلاتر الرياضية المعقدة (يتم استدعاؤه عند الرندر فقط) -->
<svg style="display:none;">
    <filter id="ai-sharpen">
        <feConvolveMatrix order="3" preserveAlpha="true" kernelMatrix="0 -1 0 -1 5 -1 0 -1 0"/>
        <feColorMatrix type="matrix" values="1.5 0 0 0 -0.2  1.5 0 0 0 -0.2  1.5 0 0 0 -0.2  0 0 0 1 0" />
    </filter>
</svg>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { alpha: false });
    const pBar = document.getElementById('p-bar');
    const pText = document.getElementById('p-text');
    const aiEngine = document.getElementById('ai-engine');
    const timerDisplay = document.getElementById('timer');
    
    let mediaRecorder;
    let recordedChunks = [];
    let isRecording = false;
    let timeLeft = 40;
    let timerInterval;

    async function startAura() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } },
                audio: true
            });
            video.srcObject = stream;
            document.getElementById('boot-screen').style.opacity = '0';
            setTimeout(() => document.getElementById('boot-screen').style.display = 'none', 1000);
        } catch (e) { alert("الكاميرا لا تعمل، يرجى تفعيل الصلاحيات."); }
    }

    function toggleCapture() {
        if (!isRecording) startRecording();
        else stopRecording();
    }

    function startRecording() {
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(video.srcObject, { mimeType: 'video/webm;codecs=vp8', bitsPerSecond: 30000000 });
        mediaRecorder.ondataavailable = e => { if(e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = runAIRender;
        
        mediaRecorder.start();
        isRecording = true;
        document.getElementById('shutter').classList.add('recording');
        
        timeLeft = 40;
        timerDisplay.style.display = 'block';
        timerInterval = setInterval(() => {
            timeLeft--;
            timerDisplay.innerText = `00:${timeLeft < 10 ? '0'+timeLeft : timeLeft}`;
            if (timeLeft <= 0) stopRecording();
        }, 1000);
    }

    function stopRecording() {
        clearInterval(timerInterval);
        mediaRecorder.stop();
        isRecording = false;
        document.getElementById('shutter').classList.remove('recording');
        timerDisplay.style.display = 'none';
    }

    async function runAIRender() {
        aiEngine.style.display = 'flex';
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        
        const tempVideo = document.createElement('video');
        tempVideo.src = url;
        tempVideo.muted = true;
        await tempVideo.play();

        canvas.width = 1080; // TikTok Ratio
        canvas.height = 1920; 

        const captureStream = canvas.captureStream(30); 
        const finalRecorder = new MediaRecorder(captureStream, { 
            mimeType: 'video/webm;codecs=vp9', 
            bitsPerSecond: 40000000 // 40Mbps (Extreme Quality)
        });
        
        const finalChunks = [];
        finalRecorder.ondataavailable = e => finalChunks.push(e.data);
        finalRecorder.onstop = () => {
            const finalBlob = new Blob(finalChunks, { type: 'video/webm' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(finalBlob);
            a.download = `AURA_NOIR_AI_${Date.now()}.webm`;
            a.click();
            location.reload();
        };

        finalRecorder.start();

        const duration = tempVideo.duration;
        let currentTime = 0;
        const fps = 30;

        async function processFrame() {
            if (currentTime >= duration) {
                finalRecorder.stop();
                return;
            }

            tempVideo.currentTime = currentTime;
            await new Promise(r => tempVideo.onseeked = r);

            // 1. تطبيق فلتر AI Noir (الحدة الفائقة والتباين السينمائي)
            ctx.filter = 'url(#ai-sharpen) contrast(1.5) brightness(0.9)';
            ctx.drawImage(tempVideo, 0, 0, canvas.width, canvas.height);
            
            // 2. تطبيق تأثير Silk Glow (توهج البشرة الاحترافي)
            ctx.globalAlpha = 0.35;
            ctx.globalCompositeOperation = "screen";
            ctx.filter = "blur(15px) brightness(1.3)";
            ctx.drawImage(canvas, 0, 0);
            
            // 3. إعادة الدمج وإضافة قناع السينما
            ctx.globalAlpha = 1.0;
            ctx.globalCompositeOperation = "source-over";
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canvas.width, 220); // Top Mask
            ctx.fillRect(0, canvas.height - 220, canvas.width, 220); // Bottom Mask

            // 4. إضافة Film Grain ناعم جداً لكسر "برودة" الكاميرا الرقمية
            ctx.fillStyle = `rgba(255,255,255,${Math.random() * 0.04})`;
            ctx.fillRect(0,0,canvas.width,canvas.height);

            currentTime += (1/fps);
            let progress = Math.floor((currentTime / duration) * 100);
            pBar.style.width = progress + "%";
            pText.innerText = progress + "%";

            requestAnimationFrame(processFrame);
        }

        processFrame();
    }
</script>
</body>
</html>